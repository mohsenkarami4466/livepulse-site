# برنامه اصلاح ناوبری و Home

## مقدمه
دو مشکل اصلی در ناوبری و صفحه Home شناسایی شده است که باعث رفتار ناخواسته (ری‌دایرکت اجباری و اجرای نشدن بخشی از کد هماهنگی) می‌شوند. این یادداشت دستورالعمل دقیق اصلاح را مستند می‌کند تا در ویرایش کد دچار خطا نشویم.

## مشکل 1: ریدایرکت اجباری در AppContent (`src/App.jsx`)
- **علت:** در useEffect ابتدای `AppContent` اگر مسیر فعلی `/` نباشد، همیشه `navigate('/')` اجرا می‌شود.
- **پیامد:** هیچ مسیر دیگری دیده نمی‌شود و همه مسیرها به خانه برمی‌گردند.
- **اصلاح پیشنهادی:**
  - شرط ریدایرکت را حذف کنید یا فقط وقتی `location.pathname === '/'` است، هایلایت خانه را فعال کنید.
  - `scrollTo(0,0)` حفظ شود.
  - فعال‌سازی هایلایت خانه فقط زمانی انجام شود که کاربر واقعاً در `/` باشد.
- **گام‌های دقیق در کد:**
  1. در useEffect `AppContent`، بخش زیر را بازبینی کنید:
     - برداشتن/غیرفعال کردن `navigate('/', { replace: true })`.
     - نگه داشتن `window.scrollTo(0, 0)`.
     - بلوک `setTimeout` برای هایلایت خانه را داخل شرط `if (location.pathname === '/')` قرار دهید تا در صفحات دیگر اجرا نشود.
  2. وابستگی useEffect می‌تواند خالی بماند (اجرا روی mount)؛ فقط منطق داخلی نباید مسیر را بازنویسی کند.

## مشکل 2: کد unreachable در Home (`src/pages/Home/Home.jsx`)
- **علت:** در useEffect اول Home، بعد از `return` cleanup، کد هماهنگی با vanilla JS نوشته شده که هرگز اجرا نمی‌شود.
- **پیامد:** هایلایت/هماهنگی با کدهای vanilla ممکن است اجرا نشود.
- **اصلاح پیشنهادی:**
  - کد هماهنگی (setTimeout و فعال‌سازی هایلایت) را به قبل از `return` منتقل کنید یا در همان effect ادغام کنید.
  - cleanup رویدادها حفظ شود.
- **گام‌های دقیق در کد:**
  1. در useEffect اول:
     - پس از `window.addEventListener('categoryChanged', handleCategoryChange)` و قبل از `return`، بلاک `setTimeout` فعال‌سازی هایلایت و غیرفعال‌سازی سایر هایلایت‌ها را قرار دهید.
     - `return` فقط شامل cleanup `removeEventListener` بماند.
  2. منطق `setCategory('home')` و sync با `window.appState` حفظ شود، ولی باید قابل‌اجرا باشد (نه بعد از `return`).

## نکات احتیاط و سازگاری
- از mutate مستقیم `window.appState` بدون sync با React پرهیز شود؛ در صورت نیاز، state React باید منبع حقیقت بماند.
- از dispatch دوباره‌ی رویدادها بدون نیاز اجتناب کنید تا حلقه ایجاد نشود.
- رفتار `window.navigate` در `Layout` پس از تغییرات مسیر، با اسکریپت‌های vanilla تست شود.

## گام‌های تست/اعتبارسنجی پس از اصلاح
1. مسیریابی بین `/`, `/news`, `/globe`, `/tutorial`, `/relax`, `/tools` بدون ریدایرکت ناخواسته.
2. در `/` اسکرول به بالا انجام می‌شود و هایلایت خانه فعال است؛ در مسیرهای دیگر هایلایت خانه به اجبار فعال نشود.
3. در Home، رویداد `categoryChanged` باعث آپدیت کارت‌ها می‌شود و هایلایت‌ها درست تنظیم می‌شوند.
4. رویدادهای `financialGlobeOpen` و `resourcesGlobeOpen` همچنان مودال‌ها را باز می‌کنند.
5. کنسول بدون خطای JS و بدون هشدار رندر دوباره ناخواسته.

